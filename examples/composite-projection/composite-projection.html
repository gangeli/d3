<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>Composite Projection</title>
<script type="text/javascript" src="../../d3.v2.js"></script>
<script type="text/javascript" src="projection.js"></script>
<script type="text/javascript" src="../../src/geo/composite.js"></script>
<script type="text/javascript" src="../../src/geo/hammer.js"></script>
<script type="text/javascript" src="../../src/geo/lambert.js"></script>
<script type="text/javascript" src="../../src/geo/mercator.js"></script>
<script type="text/javascript" src="../../src/geo/type.js"></script>
<script type="text/javascript" src="../../src/geo/path.js"></script>
<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../lib/jquery-ui/jquery-ui.min.js"></script>
<style type="text/css">

@import url("../../lib/jquery-ui/jquery-ui.css");

body, .ui-widget {
  font: 14px Helvetica Neue;
}

svg {
  width: 960px;
  height: 500px;
  border: solid 1px #000;
  background: #eee;
}

#states path {
  fill: #888;
  stroke: #fff;
}

#states circle {
  fill: #fcc;
  stroke: #000;
}

.graticule {
  fill: none;
  stroke: #333;
}

.graticule.outline {
  stroke-width: 2px;
}


#states2 path {
  fill: #888;
  stroke: #fff;
}

#states2 circle {
  fill: #fcc;
  stroke: #000;
}

#viewport {
  fill: none;
  stroke: #66a;
}

#projectionname {
  text-anchor: end;
  font-size: 20px;
  font-weight: bold;
}

table td:first-child {
  width: 120px;
  height: 26px;
}

table td:nth-child(2) {
  width: 840px;
}
</style>
</head>
<body>
<h3>Composite Projection</h3>
<script type="text/javascript">

var width = 960,
    height = 500;

// Our projection.
var xy = d3.geo.composite([0, 0, width, height]),
    path = d3.geo.path().projection(xy);

var svg = d3.select("body")
  .append("svg")
    .attr("id", "map")
    .style("position", "relative");

var states = svg.append("g")
    .attr("id", "states");

var svg2 = d3.select("body")
  .append("svg")
    .attr("id", "map2")
    .style("position", "relative");

var svg2g = svg2.append("g");

var states2 = svg2g.append("g")
    .attr("id", "states2");

d3.json("../data/world-countries.json", function(collection) {
  states
    .selectAll("path")
      .data(collection.features)
    .enter().append("path")
      .attr("d", path);
  states
    .append("circle")
      .attr("r", 10)
      .attr("transform", "translate(" + xy(xy.origin()).join(",") + ")");

  states2
    .selectAll("path")
      .data(collection.features)
    .enter().append("path")
      .attr("d", path);
});

//var graticule = d3.geo.graticule()
//  .step([20, 20]);
//
//var graticules = svg.append("g");
//
//if (1)
//graticules
//  .append("path")
//    .datum(graticule)
//    .attr("class", "graticule line")
//    .attr("d", path);
//
//if (0)
//graticules
//  .append("path")
//    .datum(graticule.outline)
//    .attr("class", "graticule outline")
//    .attr("d", path);


var viewport = svg2g.append("rect")
  .attr("id", "viewport")
  .attr("x", 0)
  .attr("y", 0)
  .attr("width", width)
  .attr("height", height);
  
//var graticules2 = svg2g.append("g");
//
//graticules2
//  .append("path")
//    .datum(graticule)
//    .attr("class", "graticule line")
//    .attr("d", path);

var projectionName = svg2.append("text")
    .attr("id", "projectionname")
    .text(xy.projectionName())
    .attr("x", width - 20)
    .attr("y", 30)
    ;


function refresh() {
  states.selectAll("path")
      .attr("d", path);
//  graticules.selectAll("path")
//      .attr("d", path);
  states.select("circle")
      .attr("transform", "translate(" + xy(xy.origin()).join(",") + ")")
  d3.select("#lon span")
      .text(xy.origin()[0]);
  d3.select("#lat span")
      .text(xy.origin()[1]);
  d3.select("#scale span")
      .text(xy.scale());
  states2.selectAll("path")
      .attr("d", path);

  svg2g.attr("transform",
    "translate(" + (width/2) + "," + (height/2) + ")" +
    "scale(" + (1/xy.scale() * 0.6) + ")" +
    "translate(" + (-width/2) + "," + (-height/2) + ")"
    );
//  graticules2.selectAll("path")
//    .attr("d", path)
//    .attr("stroke-width", xy.scale() / 0.6)
//    ;
  viewport.attr("stroke-width", xy.scale() / 0.6 * 1.4);
  projectionName.text(xy.projectionName());
}

refresh();

var mouseState = 0;
var map = document.getElementById("map");
var prevCoordinates;
map.addEventListener("mousedown", function(e) {
  mouseState = 1;
  prevCoordinates = [e.layerX, e.layerY];
});

map.addEventListener("mousemove", function(e) {
  if (mouseState == 1) {
    var coordinates = [e.layerX, e.layerY];
    var prevD = xy.invert(prevCoordinates);
    var D = xy.invert(coordinates);
    var origin = xy.origin();    
    origin[0] += prevD[0] - D[0];
    origin[1] += prevD[1] - D[1];
    xy.origin(origin);
    refresh();
    prevCoordinates = coordinates;
  }
});

document.addEventListener("mouseup", function(e) {
  mouseState = 0;
});

var mousewheel = function (e) {
  var delta = e.wheelDelta ? e.wheelDelta : e.detail,
      scale = xy.scale() + delta / 1000;
  if (scale < 0.1)
    scale = 0.1;
  xy.scale(scale);
  refresh();
  e.preventDefault();
};

map.addEventListener(map.hasOwnProperty("onmousewheel") ?
  "mousewheel" : "DOMMouseScroll", mousewheel);
</script><br><br>

<table cellpadding="0" cellspacing="0">
  <tr>
    <td>origin.longitude:</td>
    <td><div id="lon"> <span>0</span></div></td>
  </tr>
  <tr>
    <td>origin.latitude:</td>
    <td><div id="lat"> <span>0</span></div></td>
  </tr>
  <tr>
    <td>scale:</td>
    <td><div id="scale"> <span>1</span></div></td>
  </tr>
</table>

<script type="text/javascript">

$("#lon").slider({
  min: -180,
  max: 180,
  step: 1e-1,
  value: 0,
  slide: function(event, ui) {
    var origin = xy.origin();
    origin[0] = ui.value;
    xy.origin(origin);
    refresh();
  }
});

$("#lat").slider({
  min: -90,
  max: 90,
  step: 1e-1,
  value: 0,
  slide: function(event, ui) {
    var origin = xy.origin();
    origin[1] = ui.value;
    xy.origin(origin);
    refresh();
  }
});

$("#scale").slider({
  min: 0.1,
  max: 17,
  step: 0.1,
  value: 1,
  slide: function(event, ui) {
    xy.scale(ui.value);
    refresh();
  }
});

</script>
</body>
</html>
